<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>THE POS v11.7</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { margin: 0; font-family: sans-serif; background: #000; color: #fff; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
        #reader { width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 1; }
        
        /* „É≠„Ç∞„Ç¢„Ç¶„Éà„Éú„Çø„É≥ */
        #logout-btn { 
            position: absolute; top: 15px; right: 15px; z-index: 110; 
            padding: 10px 15px; background: rgba(255,0,0,0.8); color: white; 
            border: none; border-radius: 10px; font-weight: bold; display: none;
        }

        #step-indicator { 
            position: absolute; top: 15px; left: 15px; z-index: 100; 
            padding: 12px 20px; border-radius: 50px; font-weight: bold; font-size: 14px;
        }
        .step-prepaid { background: #007bff; border: 2px solid #fff; }
        .step-item { background: #ffc107; color: #000; }

        .main-panel { 
            position: absolute; bottom: 0; width: 100%; background: #fff; color: #222; 
            z-index: 10; padding-bottom: env(safe-area-inset-bottom); text-align: center; border-radius: 30px 30px 0 0; 
        }
        #user-info { font-size: 14px; color: #007bff; margin: 15px 0 5px; font-weight: bold; }
        #item-price { font-size: 60px; font-weight: 900; color: #f50057; margin: 5px 0; }
        #buy-btn { width: 90%; padding: 18px; background: #f50057; color: white; border: none; border-radius: 50px; font-size: 24px; font-weight: bold; display: none; margin-bottom: 20px; }
        
        #pay-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 100; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <button id="logout-btn" onclick="logout()">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
    <div id="step-indicator" class="step-prepaid">1. ‰ºöÂì°Ë®º„Çí„Çπ„Ç≠„É£„É≥</div>
    <div id="reader"></div>

    <div class="main-panel">
        <div id="user-info">üí≥ „É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
        <div id="item-name" style="font-weight:bold;">ÂïÜÂìÅ„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ</div>
        <div id="item-price">¬• 0</div>
        <button id="buy-btn" onclick="executePayment()">Ë≥ºÂÖ•„ÇíÁ¢∫ÂÆö</button>
    </div>

    <div id="pay-overlay">
        <div style="background:#fff; padding:30px; border-radius:30px; color:#333; width:80%; text-align:center;">
            <h2>Ê±∫Ê∏àÂÆå‰∫ÜÔºÅ</h2>
            <div id="qrcode" style="margin:20px 0; display:flex; justify-content:center;"></div>
            <div id="new-balance-text" style="font-size:24px; font-weight:bold; color:#f50057;"></div>
            <button onclick="closeOverlay()" style="background:#00e676; border:none; padding:15px 50px; border-radius:50px; font-weight:bold; margin-top:20px;">Á∂ö„Åë„Å¶Ë≤∑„ÅÑÁâ©„ÇíÂà∑„Çã</button>
        </div>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyvNJwfAIlUvqy1B98fMpPsOsAYlY710BMFEX--peJ7ob0dt8MiqbDdiAs444iRkRMmQg/exec";
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQk46CrTJJU-4KMeCxx1DUZCv367fzhXAtdjzWEW0eDT1VdgvGCk4C-NQATkqbjhsZzDoeWQDVdjxHV/pub?gid=0&single=true&output=csv";
        
        let currentUser = null;
        let selectedItem = null;

        // Âú®Â∫´ÂêåÊúü
        async function syncInventory() {
            const res = await fetch(SHEET_URL + "&cb=" + Date.now());
            const rows = (await res.text()).split(/\r?\n/).map(r => r.split(','));
            localStorage.setItem('inv', JSON.stringify({ [rows[0][1].replace(/\D/g,"")]: { name: rows[1][1], price: parseInt(rows[2][1]) } }));
        }

        // Ê±∫Ê∏àÂá¶ÁêÜ
        async function executePayment() {
            if (!currentUser || !selectedItem) return;
            const newAmount = -selectedItem.price;
            document.getElementById('buy-btn').innerText = "ÈÄö‰ø°‰∏≠...";
            
            await fetch(`${GAS_URL}?id=${currentUser.id}&amount=${newAmount}`, { mode: 'no-cors' });
            
            const finalBal = currentUser.balance - selectedItem.price;
            currentUser.balance = finalBal; // „É≠„Éº„Ç´„É´„ÅÆÊÆãÈ´ò„ÇÇÊõ¥Êñ∞
            sessionStorage.setItem('loggedInUser', JSON.stringify(currentUser)); // „Çª„ÉÉ„Ç∑„Éß„É≥‰øùÂ≠ò

            document.getElementById('new-balance-text').innerText = `Êñ∞ÊÆãÈ´ò: ¬•${finalBal}`;
            document.getElementById('qrcode').innerHTML = "";
            new QRCode(document.getElementById("qrcode"), { text: `${currentUser.id}-${finalBal}`, width: 200, height: 200 });
            document.getElementById('pay-overlay').style.display = 'flex';
        }

        function closeOverlay() {
            document.getElementById('pay-overlay').style.display = 'none';
            resetItemDisplay();
        }

        function resetItemDisplay() {
            selectedItem = null;
            document.getElementById('item-name').innerText = "Ê¨°„ÅÆÂïÜÂìÅ„Çí„Çπ„Ç≠„É£„É≥";
            document.getElementById('item-price').innerText = "¬• 0";
            document.getElementById('buy-btn').style.display = 'none';
            document.getElementById('buy-btn').innerText = "Ë≥ºÂÖ•„ÇíÁ¢∫ÂÆö";
            updateUI();
        }

        function updateUI() {
            if (currentUser) {
                document.getElementById('user-info').innerText = `‰ºöÂì°:${currentUser.id} | ÊÆãÈ´ò:¬•${currentUser.balance}`;
                document.getElementById('logout-btn').style.display = 'block';
                document.getElementById('step-indicator').innerText = "2. ÂïÜÂìÅ„Çí„Çπ„Ç≠„É£„É≥";
                document.getElementById('step-indicator').className = "step-item";
            } else {
                document.getElementById('user-info').innerText = "üí≥ „É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ";
                document.getElementById('logout-btn').style.display = 'none';
                document.getElementById('step-indicator').innerText = "1. ‰ºöÂì°Ë®º„Çí„Çπ„Ç≠„É£„É≥";
                document.getElementById('step-indicator').className = "step-prepaid";
            }
        }

        function logout() {
            sessionStorage.removeItem('loggedInUser');
            location.reload();
        }

        window.onload = async () => {
            await syncInventory();
            
            // „Çª„ÉÉ„Ç∑„Éß„É≥„Åã„Çâ„É≠„Ç∞„Ç§„É≥ÊÉÖÂ†±„ÇíÂæ©ÂÖÉ
            const savedUser = sessionStorage.getItem('loggedInUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                updateUI();
            }

            const scanner = new Html5Qrcode("reader");
            scanner.start({ facingMode: "environment" }, { fps: 30, qrbox: (w,h)=>({width:w*0.8, height:h*0.5}) }, async (text) => {
                const parts = text.split('-');
                
                // ‰ºöÂì°„Çπ„Ç≠„É£„É≥ÔºàÊú™„É≠„Ç∞„Ç§„É≥ÊôÇ„ÅÆ„ÅøÔºâ
                if (!currentUser && parts.length >= 2) {
                    const id = parts[0];
                    document.getElementById('user-info').innerText = "„Çµ„Éº„Éê„ÉºÁÖß‰ºö‰∏≠...";
                    const res = await fetch(`${GAS_URL}?id=${id}`);
                    const data = await res.json();
                    currentUser = { id: data.id, balance: data.balance };
                    sessionStorage.setItem('loggedInUser', JSON.stringify(currentUser));
                    updateUI();
                    return;
                }

                // ÂïÜÂìÅ„Çπ„Ç≠„É£„É≥Ôºà„É≠„Ç∞„Ç§„É≥‰∏≠„ÅÆ„ÅøÔºâ
                if (currentUser) {
                    const code = text.replace(/\D/g,"");
                    const inv = JSON.parse(localStorage.getItem('inv'));
                    if (inv[code]) {
                        selectedItem = inv[code];
                        document.getElementById('item-name').innerText = selectedItem.name;
                        document.getElementById('item-price').innerText = `¬• ${selectedItem.price}`;
                        document.getElementById('buy-btn').style.display = 'inline-block';
                    }
                }
            });
        };
    </script>
</body>
</html>
