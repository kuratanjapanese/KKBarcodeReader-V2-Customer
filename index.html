<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>在庫連動レジ v9.0</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        html, body { margin: 0; padding: 0; width: 100%; height: 100dvh; overflow: hidden; font-family: sans-serif; background: #000; color: #fff; display: flex; flex-direction: column; }
        .header { height: 40px; background: #222; display: flex; align-items: center; justify-content: center; border-bottom: 2px solid #00ffcc; }
        #reader { flex-grow: 1; width: 100%; }
        .info-panel { background: white; color: #333; padding: 15px; border-top-left-radius: 20px; border-top-right-radius: 20px; text-align: center; }
        .price-tag { font-size: 32px; color: #ff0033; font-weight: bold; }
        .stock-info { font-size: 12px; color: #666; }
        #new-qr-container { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 15px; text-align: center; z-index: 100; color: #000; box-shadow: 0 0 20px rgba(0,255,204,0.5); }
        .close-btn { background: #00ffcc; color: #000; border: none; padding: 10px 20px; border-radius: 5px; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="header"><div style="color:#00ffcc; font-weight:bold;">POS SYSTEM v9.0</div></div>
    <div id="reader"></div>

    <div class="info-panel">
        <div id="item-name" style="font-weight:bold;">スキャン待ち...</div>
        <div id="display-price" class="price-tag">¥ ---</div>
        <div id="display-stock" class="stock-info">在庫: --</div>
    </div>

    <div id="new-qr-container">
        <p style="font-weight:bold;">決済完了！新しい残高コード</p>
        <div id="qrcode"></div>
        <p id="new-code-text" style="font-size: 10px;"></p>
        <button class="close-btn" onclick="closeQR()">OK (次へ)</button>
    </div>

    <script>
        let isScanning = true;
        let currentItem = null; // 現在スキャンされている商品の情報

        // --- 1. 商品検索（管理画面の在庫を優先） ---
        async function findProduct(jan) {
            const inventory = JSON.parse(localStorage.getItem('shop_inventory')) || {};
            
            if (inventory[jan]) {
                // 自作管理画面にデータがある場合
                return { ...inventory[jan], jan: jan, source: 'local' };
            } else {
                // ない場合はYahoo APIで探す（デモ用）
                const CLIENT_ID = "dj00aiZpPUZYTWdEYTdlSHF1aCZzPWNvbnN1bWVyc2VjcmV0Jng9Zjc-";
                const url = `https://corsproxy.io/?${encodeURIComponent("https://shopping.yahooapis.jp/ShoppingWebService/V3/itemSearch?appid="+CLIENT_ID+"&jan_code="+jan)}`;
                try {
                    const res = await fetch(url);
                    const data = await res.json();
                    if (data.hits && data.hits.length > 0) {
                        return { name: data.hits[0].name, price: data.hits[0].price, stock: 99, source: 'api' };
                    }
                } catch (e) { return null; }
            }
            return null;
        }

        // --- 2. 偽造防止ロジック ---
        function verifyPrepaid(text) {
            const parts = text.split('-');
            if (parts.length !== 4) return null;
            const [id, balStr, idAlpha, checkStr] = parts;
            const balance = parseInt(balStr);
            const checkNum = parseInt(checkStr);

            const alphabet = "ABCDEFGHIJ";
            const expectedAlpha = id.split('').map(n => alphabet[parseInt(n)]).join('');
            const expectedCheckNum = Math.round((balance + parseInt(id)) / 2);

            return (idAlpha === expectedAlpha && checkNum === expectedCheckNum) ? { id, balance } : null;
        }

        // --- 3. 決済実行（在庫を減らす） ---
        function executePayment(userData) {
            if (!currentItem) return alert("先に商品をスキャンしてね");
            
            if (userData.balance < currentItem.price) return alert("残高が足りないよ！");
            if (currentItem.stock <= 0) return alert("売り切れです！");

            // 在庫を減らす（管理画面のデータを更新）
            if (currentItem.source === 'local') {
                const inventory = JSON.parse(localStorage.getItem('shop_inventory'));
                inventory[currentItem.jan].stock -= 1;
                localStorage.setItem('shop_inventory', JSON.stringify(inventory));
            }

            // 新しい残高QR生成
            const newBal = userData.balance - currentItem.price;
            generateNewQR(userData.id, newBal);
            
            alert(`【${currentItem.name}】を購入しました！`);
            currentItem = null; 
            updateDisplay("スキャン待ち...", "---", "--");
        }

        function updateDisplay(name, price, stock) {
            document.getElementById('item-name').innerText = name;
            document.getElementById('display-price').innerText = `¥ ${price}`;
            document.getElementById('display-stock').innerText = `在庫: ${stock}`;
        }

        function generateNewQR(id, newBalance) {
            const alphabet = "ABCDEFGHIJ";
            const idAlpha = id.split('').map(n => alphabet[parseInt(n)]).join('');
            const checkNum = Math.round((newBalance + parseInt(id)) / 2);
            const newCode = `${id}-${newBalance}-${idAlpha}-${checkNum}`;
            document.getElementById('qrcode').innerHTML = "";
            new QRCode(document.getElementById("qrcode"), { text: newCode, width: 160, height: 160 });
            document.getElementById('new-qr-container').style.display = 'block';
            isScanning = false;
        }

        function closeQR() {
            document.getElementById('new-qr-container').style.display = 'none';
            isScanning = true;
        }

        window.onload = () => {
            const scanner = new Html5Qrcode("reader");
            scanner.start({ facingMode: "environment" }, { fps: 20, qrbox: 250 }, async (text) => {
                if (!isScanning) return;

                const userData = verifyPrepaid(text);
                if (userData) {
                    executePayment(userData);
                } else {
                    const product = await findProduct(text);
                    if (product) {
                        currentItem = product;
                        updateDisplay(product.name, product.price.toLocaleString(), product.stock);
                    }
                }
            });
        };
    </script>
</body>
</html>
