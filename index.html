<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>THE SERVER POS v11.6</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { margin: 0; font-family: sans-serif; background: #000; color: #fff; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
        #reader { width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 1; }
        #step-indicator { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); z-index: 100; padding: 12px 30px; border-radius: 50px; font-weight: bold; width: 80%; text-align: center; }
        .step-prepaid { background: #007bff; border: 2px solid #fff; }
        .step-item { background: #ffc107; color: #000; }
        .main-panel { position: absolute; bottom: 0; width: 100%; background: #fff; color: #222; border-top-radius: 30px; z-index: 10; padding-bottom: env(safe-area-inset-bottom); text-align: center; border-radius: 30px 30px 0 0; }
        #user-info { font-size: 14px; color: #007bff; margin: 15px 0 5px; font-weight: bold; }
        #item-price { font-size: 60px; font-weight: 900; color: #f50057; margin: 5px 0; }
        #buy-btn { width: 90%; padding: 18px; background: #f50057; color: white; border: none; border-radius: 50px; font-size: 24px; font-weight: bold; display: none; margin-bottom: 20px; }
        #pay-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 100; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div id="step-indicator" class="step-prepaid">1. ä¼šå“¡è¨¼ã‚’ã‚¹ã‚­ãƒ£ãƒ³</div>
    <div id="reader"></div>

    <div class="main-panel">
        <div id="user-info">ğŸ’³ ã‚µãƒ¼ãƒãƒ¼åŒæœŸå¾…æ©Ÿä¸­...</div>
        <div id="item-name" style="font-weight:bold;">å•†å“ã‚’é¸ã‚“ã§ãã ã•ã„</div>
        <div id="item-price">Â¥ 0</div>
        <button id="buy-btn" onclick="executePayment()">è³¼å…¥ã‚’ç¢ºå®šï¼ˆæ®‹é«˜æ¸›ç®—ï¼‰</button>
    </div>

    <div id="pay-overlay">
        <div style="background:#fff; padding:30px; border-radius:30px; color:#333; width:80%; text-align:center;">
            <h2 id="finish-msg">æ±ºæ¸ˆå®Œäº†ï¼</h2>
            <div id="qrcode" style="margin:20px 0; display:flex; justify-content:center;"></div>
            <div id="new-balance-text" style="font-size:24px; font-weight:bold; color:#f50057;"></div>
            <button onclick="location.reload()" style="background:#00e676; border:none; padding:15px 50px; border-radius:50px; font-weight:bold; margin-top:20px;">æ¬¡ã¸</button>
        </div>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyvNJwfAIlUvqy1B98fMpPsOsAYlY710BMFEX--peJ7ob0dt8MiqbDdiAs444iRkRMmQg/exec";
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQk46CrTJJU-4KMeCxx1DUZCv367fzhXAtdjzWEW0eDT1VdgvGCk4C-NQATkqbjhsZzDoeWQDVdjxHV/pub?gid=0&single=true&output=csv";
        
        let currentUser = null;
        let selectedItem = null;

        async function syncInventory() {
            const res = await fetch(SHEET_URL + "&cb=" + Date.now());
            const rows = (await res.text()).split(/\r?\n/).map(r => r.split(','));
            localStorage.setItem('inv', JSON.stringify({ [rows[0][1].replace(/\D/g,"")]: { name: rows[1][1], price: parseInt(rows[2][1]) } }));
        }

        async function executePayment() {
            const newAmount = -selectedItem.price; // ãƒã‚¤ãƒŠã‚¹å€¤ã‚’é€ã£ã¦æ¸›ã‚‰ã™
            document.getElementById('buy-btn').innerText = "é€šä¿¡ä¸­...";
            
            // ã‚µãƒ¼ãƒãƒ¼ã®æ®‹é«˜ã‚’æ¸›ã‚‰ã™ï¼
            await fetch(`${GAS_URL}?id=${currentUser.id}&amount=${newAmount}`, { mode: 'no-cors' });
            
            const finalBal = currentUser.balance - selectedItem.price;
            document.getElementById('new-balance-text').innerText = `æ®‹é«˜: Â¥${finalBal}`;
            
            // æ–°ã—ã„QRç”Ÿæˆ
            const alphabet = "ABCDEFGHIJ";
            const alpha = currentUser.id.split('').map(n => alphabet[parseInt(n)]).join('');
            const check = Math.round((finalBal + parseInt(currentUser.id)) / 2);
            new QRCode(document.getElementById("qrcode"), { text: `${currentUser.id}-${finalBal}-${alpha}-${check}`, width: 200, height: 200 });
            
            document.getElementById('pay-overlay').style.display = 'flex';
        }

        window.onload = async () => {
            await syncInventory();
            const scanner = new Html5Qrcode("reader");
            scanner.start({ facingMode: "environment" }, { fps: 30, qrbox: (w,h)=>({width:w*0.8, height:h*0.5}) }, async (text) => {
                const parts = text.split('-');
                
                // 1. ä¼šå“¡ã‚¹ã‚­ãƒ£ãƒ³
                if (!currentUser && parts.length >= 2) {
                    const id = parts[0];
                    document.getElementById('user-info').innerText = "ã‚µãƒ¼ãƒãƒ¼ç…§ä¼šä¸­...";
                    
                    // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æœ€æ–°æ®‹é«˜ï¼ˆ810å††ï¼‰ã‚’å–å¾—ï¼
                    const res = await fetch(`${GAS_URL}?id=${id}`);
                    const data = await res.json();
                    
                    currentUser = { id: data.id, balance: data.balance };
                    document.getElementById('user-info').innerText = `ä¼šå“¡:${currentUser.id} | ã‚µãƒ¼ãƒãƒ¼æ®‹é«˜:Â¥${currentUser.balance}`;
                    document.getElementById('step-indicator').innerText = "2. å•†å“ã‚’ã‚¹ã‚­ãƒ£ãƒ³";
                    document.getElementById('step-indicator').className = "step-item";
                    return;
                }

                // 2. å•†å“ã‚¹ã‚­ãƒ£ãƒ³
                const code = text.replace(/\D/g,"");
                const inv = JSON.parse(localStorage.getItem('inv'));
                if (inv[code]) {
                    selectedItem = inv[code];
                    document.getElementById('item-name').innerText = selectedItem.name;
                    document.getElementById('item-price').innerText = `Â¥ ${selectedItem.price}`;
                    document.getElementById('buy-btn').style.display = 'inline-block';
                }
            });
        };
    </script>
</body>
</html>
